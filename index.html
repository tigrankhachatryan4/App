<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Headache Diary</title>

  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Headache Diary">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#4facfe">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
  <link rel="icon" type="image/png" href="icon-192.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    /* === Your full CSS from the long working file goes here === */
    /* I won‚Äôt shorten it ‚Äî keep all styles (container, header, buttons, calendar, modals, etc.) */
  </style>
</head>
<body>
  <!-- PIN Authentication Section -->
  <div id="pinSection" class="pin-section">
    <div class="pin-container">
      <h2 class="pin-title" id="pinTitle">Welcome to Headache Diary</h2>
      <p class="pin-subtitle" id="pinSubtitle">Enter your 4-digit PIN to continue</p>
      <div class="pin-inputs">
        <input type="password" class="pin-input" maxlength="1" id="pin1" oninput="handlePinInput(1)">
        <input type="password" class="pin-input" maxlength="1" id="pin2" oninput="handlePinInput(2)">
        <input type="password" class="pin-input" maxlength="1" id="pin3" oninput="handlePinInput(3)">
        <input type="password" class="pin-input" maxlength="1" id="pin4" oninput="handlePinInput(4)">
      </div>
      <button class="btn" id="pinButton" onclick="handlePinSubmit()">Enter</button>
      <div class="pin-error hidden" id="pinError"></div>
      <div id="createPinSection" class="hidden">
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
          First time? Your PIN will be saved for future access.
        </p>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="container">
    <div class="header">
      <button class="settings-gear" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
      <h1>ü©∫ Headache Diary</h1>
      <p>Professional headache tracking system</p>
      <div id="installPrompt" class="install-prompt">
        Tap "Share" then "Add to Home Screen" to install this app
      </div>
    </div>

    <div class="content">
      <!-- Messages -->
      <div id="errorMessage" class="error-message hidden"></div>
      <div id="successMessage" class="success-message hidden"></div>

      <!-- Dashboard -->
      <div id="dashboardSection">
        <div class="dashboard">
          <div id="incompleteReminder" class="reminder-box hidden">
            <h4>‚ö†Ô∏è Incomplete Headache Entries</h4>
            <p>You have headache entries without end times. Please update them when your headaches resolve.</p>
            <button class="btn" onclick="showIncompleteEntries()">View Incomplete Entries</button>
          </div>
          <div class="welcome-message">
            <h3>Personal Headache Tracker</h3>
            <p>Track your headaches to identify patterns and improve your health</p>
          </div>
          <button class="btn btn-large btn-report" onclick="showReportHeadache()">üìù Report Headache</button>
          <button class="btn btn-large btn-edit" onclick="showAllEntries()">üìù Edit Entries</button>
          <button class="btn btn-large btn-summary" onclick="showHeadacheSummary()">üìä Headache Summary</button>
        </div>
      </div>

      <!-- Edit Entries -->
      <div id="editEntriesSection" class="hidden">
        <h2 style="margin-bottom: 20px;">Edit Headache Entries</h2>
        <div class="entry-list" id="allEntriesList"></div>
        <button class="btn btn-cancel" onclick="backToDashboard()" style="margin-top: 20px;">Back to Dashboard</button>
      </div>

      <!-- Report Headache -->
      <div id="reportSection" class="hidden">
        <h2 style="margin-bottom: 20px;">
          <span id="reportTitle">Report New Headache</span>
          <span id="editingIndicator" class="hidden" style="color: #4facfe; font-size: 16px;">(Editing)</span>
        </h2>
        <!-- Intensity, duration, symptoms, triggers, relief, menstrual toggle... -->
        <!-- Save, Cancel, Delete buttons -->
      </div>

      <!-- Summary Section -->
      <div id="summarySection" class="hidden">
        <h2 style="margin-bottom: 20px;">Headache Summary</h2>
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
            <h3 id="currentMonth"></h3>
            <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <button class="btn btn-cancel" onclick="backToDashboard()">Back to Dashboard</button>
        <div id="clockView" class="clock-view hidden">
          <h3 id="clockDate"></h3>
          <p>Headaches throughout the day</p>
          <div class="clock-container">
            <div class="clock-face" id="clockFace">
              <div class="clock-numbers" id="clockNumbers"></div>
            </div>
          </div>
          <div id="symptomsDisplay" class="symptoms-display hidden">
            <h4>Details for This Day:</h4>
            <div id="symptomsText"></div>
            <div id="triggersText"></div>
            <div id="reliefText"></div>
          </div>
          <button class="btn btn-cancel" onclick="closeClockView()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <h2 class="settings-title">Settings</h2>
      <button class="btn settings-button" onclick="showChangePinDialog()">üîê Change PIN</button>
      <button class="btn settings-button" style="background: #dc3545;" onclick="confirmLogout()">üö™ Logout</button>
      <button class="btn btn-cancel" onclick="hideSettings()">Cancel</button>
    </div>
  </div>

  <!-- Change PIN Modal -->
  <div id="changePinModal" class="settings-modal">
    <div class="settings-content">
      <h2 class="settings-title">Change PIN</h2>
      <p style="color: #666; margin-bottom: 20px;">Enter a new 4-digit PIN</p>
      <div class="pin-inputs">
        <input type="password" class="pin-input" maxlength="1" id="newPin1" oninput="handleNewPinInput(1)">
        <input type="password" class="pin-input" maxlength="1" id="newPin2" oninput="handleNewPinInput(2)">
        <input type="password" class="pin-input" maxlength="1" id="newPin3" oninput="handleNewPinInput(3)">
        <input type="password" class="pin-input" maxlength="1" id="newPin4" oninput="handleNewPinInput(4)">
      </div>
      <button class="btn" onclick="saveNewPin()">Save New PIN</button>
      <button class="btn btn-cancel" onclick="hideChangePinDialog()">Cancel</button>
      <div class="pin-error hidden" id="changePinError"></div>
    </div>
  </div>

  <!-- Footer -->
  <div style="text-align: center; padding: 20px; color: white; font-size: 12px; margin-top: 20px;">
    ¬© 2024 Armenian Neuroscience Institute. All rights reserved.<br>
    Proprietary medical software for headache tracking.
  </div>

  <script>
    // === Keep all your original JavaScript functions here (saveHeadacheEntry, editEntry, calendar, PIN logic, etc.) ===
    // --- FIXED PWA setup ---
    function setupPWA() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      }
      if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
        if (!window.navigator.standalone) {
          document.getElementById('installPrompt').style.display = 'block';
        } else {
          document.getElementById('installPrompt').style.display = 'none';
        }
      }
    }

    // --- FIXED deleteCurrentEntry ---
    function deleteCurrentEntry() {
      if (!editingEntryId) {
        alert('No entry selected for deletion');
        return;
      }
      if (confirm('Are you sure you want to delete this headache entry?')) {
        const index = headacheEntries.findIndex(e => e.id === editingEntryId);
        if (index !== -1) {
          headacheEntries.splice(index, 1);
          saveHeadacheData();
          showSuccess('Headache entry deleted successfully!');
          clearReportForm();
          editingEntryId = null;
          backToDashboard();
        }
      }
    }

    // --- FIXED confirmLogout ---
    function confirmLogout() {
      if (confirm('Are you sure you want to logout?')) {
        hideSettings();
        document.getElementById('pinSection').style.display = 'flex';
        clearPinInputs();
        savedPin = localStorage.getItem('headacheDiaryPin');
        isFirstTimeUser = !savedPin;
        checkPinStatus();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      checkPinStatus();
      setupPWA();
    });

    // === rest of your existing JS code goes here ===
  </script>
</body>
</html>
