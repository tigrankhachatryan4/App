<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headache Diary</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Headache Diary">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4facfe">

    <!-- App Icons (PNG files you add below) -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- Manifest (external file) -->
    <link rel="manifest" href="manifest.json">

    <style>
        /* === (unchanged styles from your app) === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px 20px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .install-prompt { background: rgba(255,255,255,0.9); color: #333; padding: 10px 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; display: none; }
        .content { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; resize: none; }
        input:focus, textarea:focus { outline: none; border-color: #4facfe; }
        .btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease; margin-right: 10px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-cancel { background: #6c757d; }
        .btn-large { width: 100%; padding: 20px; font-size: 18px; margin-bottom: 15px; }
        .btn-report { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); }
        .btn-edit { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .btn-summary { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); }
        .btn-start { background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: all 0.3s ease; }
        .btn-stop { background: linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: all 0.3s ease; }
        .time-control { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .intensity-selector { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .intensity-btn { padding: 12px 16px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; flex: 1; min-width: 120px; text-align: center; }
        .intensity-mild { background: #d4edda; color: #155724; }
        .intensity-moderate { background: #fff3cd; color: #856404; }
        .intensity-severe { background: #f8d7da; color: #721c24; }
        .intensity-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .intensity-btn.selected { border-color: #333; transform: scale(1.05); }
        .time-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .hidden { display: none; }
        .dashboard { text-align: center; }
        .welcome-message { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .reminder-box { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .reminder-box h4 { margin-bottom: 10px; color: #d63031; }
        .calendar-container { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav { background: #4facfe; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; position: relative; }
        .calendar-day:hover { transform: scale(1.1); }
        .calendar-day.has-mild { background: #d4edda; color: #155724; }
        .calendar-day.has-moderate { background: #fff3cd; color: #856404; }
        .calendar-day.has-severe { background: #f8d7da; color: #721c24; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-weekday { font-weight: 600; color: #666; padding: 10px; text-align: center; }
        .clock-view { background: white; border-radius: 12px; padding: 30px; margin-top: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .clock-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        .clock-face { width: 100%; height: 100%; border-radius: 50%; position: relative; background: #f8f9fa; border: 3px solid #dee2e6; }
        .clock-numbers { position: absolute; width: 100%; height: 100%; }
        .clock-number { position: absolute; font-weight: 600; color: #333; }
        .symptoms-display { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .symptoms-display h4 { margin-bottom: 10px; color: #333; }
        .error-message { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .success-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .entry-list { max-height: 400px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; background: #f8f9fa; }
        .entry-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #4facfe; cursor: pointer; transition: all 0.3s ease; }
        .entry-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .entry-item.severity-mild { border-left-color: #28a745; }
        .entry-item.severity-moderate { border-left-color: #ffc107; }
        .entry-item.severity-severe { border-left-color: #dc3545; }
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .entry-date { font-weight: 600; color: #333; }
        .entry-intensity { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .edit-mode { background: #e3f2fd; border: 2px solid #4facfe; }
        .menstrual-toggle { display: flex; align-items: center; gap: 15px; margin-top: 20px; }
        .toggle-switch { position: relative; width: 60px; height: 30px; background: #e2e8f0; border-radius: 30px; cursor: pointer; transition: background 0.3s ease; }
        .toggle-switch.active { background: #dc3545; }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.active .toggle-slider { transform: translateX(30px); }
        .calendar-day.has-menstrual { border: 3px solid #dc3545 !important; font-weight: bold; }
        .settings-gear { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .settings-gear:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
        .settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .settings-modal.show { display: flex; }
        .settings-content { background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; text-align: center; }
        .settings-title { font-size: 24px; font-weight: 600; margin-bottom: 25px; color: #333; }
        .settings-button { width: 100%; margin-bottom: 15px; }
        .pin-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .pin-container { background: white; border-radius: 16px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px; width: 90%; }
        .pin-title { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 10px; }
        .pin-subtitle { color: #666; margin-bottom: 30px; }
        .pin-inputs { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .pin-input { width: 50px; height: 60px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 24px; text-align: center; font-weight: 600; transition: all 0.3s ease; }
        .pin-input:focus { border-color: #4facfe; outline: none; transform: scale(1.05); }
        .pin-input.filled { background: #e3f2fd; border-color: #4facfe; }
        .pin-error { color: #dc3545; margin-top: 10px; font-size: 14px; }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .time-inputs { grid-template-columns: 1fr; }
            .clock-container { width: 250px; height: 250px; }
            .calendar-grid { font-size: 14px; }
        }
    </style>
</head>
<body>
    <!-- PIN Authentication Section -->
    <div id="pinSection" class="pin-section">
        <div class="pin-container">
            <h2 class="pin-title" id="pinTitle">Welcome to Headache Diary</h2>
            <p class="pin-subtitle" id="pinSubtitle">Enter your 4-digit PIN to continue</p>
            <div class="pin-inputs">
                <input type="password" class="pin-input" maxlength="1" id="pin1" oninput="handlePinInput(1)">
                <input type="password" class="pin-input" maxlength="1" id="pin2" oninput="handlePinInput(2)">
                <input type="password" class="pin-input" maxlength="1" id="pin3" oninput="handlePinInput(3)">
                <input type="password" class="pin-input" maxlength="1" id="pin4" oninput="handlePinInput(4)">
            </div>
            <button class="btn" id="pinButton" onclick="handlePinSubmit()">Enter</button>
            <div class="pin-error hidden" id="pinError"></div>
            <div id="createPinSection" class="hidden">
                <p style="margin-top: 20px; color: #666; font-size: 14px;">First time? Your PIN will be saved for future access.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="settings-gear" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
            <h1>ü©∫ Headache Diary</h1>
            <p>Professional headache tracking system</p>
            <div id="installPrompt" class="install-prompt">
                Tap "Share" then "Add to Home Screen" to install this app
            </div>
        </div>

        <div class="content">
            <!-- Messages -->
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>

            <!-- Dashboard -->
            <div id="dashboardSection">
                <div class="dashboard">
                    <div id="incompleteReminder" class="reminder-box hidden">
                        <h4>‚ö†Ô∏è Incomplete Headache Entries</h4>
                        <p>You have headache entries without end times. Please update them when your headaches resolve.</p>
                        <button class="btn" onclick="showIncompleteEntries()">View Incomplete Entries</button>
                    </div>
                    <div class="welcome-message">
                        <h3>Personal Headache Tracker</h3>
                        <p>Track your headaches to identify patterns and improve your health</p>
                    </div>
                    <button class="btn btn-large btn-report" onclick="showReportHeadache()">üìù Report Headache</button>
                    <button class="btn btn-large btn-edit" onclick="showAllEntries()">üìù Edit Entries</button>
                    <button class="btn btn-large btn-summary" onclick="showHeadacheSummary()">üìä Headache Summary</button>
                </div>
            </div>

            <!-- Edit Entries -->
            <div id="editEntriesSection" class="hidden">
                <h2 style="margin-bottom: 20px;">Edit Headache Entries</h2>
                <div class="entry-list" id="allEntriesList"></div>
                <button class="btn btn-cancel" onclick="backToDashboard()" style="margin-top: 20px;">Back to Dashboard</button>
            </div>

            <!-- Report Headache -->
            <div id="reportSection" class="hidden">
                <h2 style="margin-bottom: 20px;">
                    <span id="reportTitle">Report New Headache</span>
                    <span id="editingIndicator" class="hidden" style="color: #4facfe; font-size: 16px;">(Editing)</span>
                </h2>

                <div class="form-group">
                    <label>Headache Intensity *</label>
                    <div class="intensity-selector">
                        <div class="intensity-btn intensity-mild" data-intensity="mild" onclick="selectIntensity('mild')">Mild<br><small>(1-4/10)</small></div>
                        <div class="intensity-btn intensity-moderate" data-intensity="moderate" onclick="selectIntensity('moderate')">Moderate<br><small>(5-7/10)</small></div>
                        <div class="intensity-btn intensity-severe" data-intensity="severe" onclick="selectIntensity('severe')">Severe<br><small>(8-10/10)</small></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Duration *</label>
                    <div class="time-inputs">
                        <div>
                            <div class="time-control"><button class="btn-start" onclick="setCurrentTime('start')">üü¢ Start Now</button></div>
                            <label for="startTime" style="font-size: 14px; margin-bottom: 5px;">Start Time</label>
                            <input type="datetime-local" id="startTime">
                        </div>
                        <div>
                            <div class="time-control"><button class="btn-stop" onclick="setCurrentTime('end')">üî¥ Stop Now</button></div>
                            <label for="endTime" style="font-size: 14px; margin-bottom: 5px;">End Time (may complete later)</label>
                            <input type="datetime-local" id="endTime">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="symptoms">Associated Symptoms</label>
                    <textarea id="symptoms" rows="3" placeholder="e.g., light sensitivity, noise sensitivity, nausea, vomiting, visual changes..."></textarea>
                </div>

                <div class="form-group">
                    <label for="triggers">What Made it Worse</label>
                    <textarea id="triggers" rows="3" placeholder="e.g., physical activity, standing up, lying down, stress, bright lights..."></textarea>
                </div>

                <div class="form-group">
                    <label for="relief">What Made it Better</label>
                    <textarea id="relief" rows="3" placeholder="e.g., medications taken, sleep, dark quiet room, specific position, cold/heat..."></textarea>
                </div>

                <div class="form-group">
                    <div class="menstrual-toggle">
                        <span style="font-weight: 600; color: #333;">Menstrual Period</span>
                        <div class="toggle-switch" id="menstrualToggle" onclick="toggleMenstrual()"><div class="toggle-slider"></div></div>
                        <input type="checkbox" id="menstrualPeriod" style="display: none;">
                    </div>
                </div>

                <button class="btn" onclick="saveHeadacheEntry()">üíæ Save Entry</button>
                <button class="btn btn-cancel" onclick="cancelReport()">Cancel</button>

                <div id="incompleteEntriesList" class="hidden" style="margin-top: 30px;">
                    <h3>Incomplete Entries</h3>
                    <div class="entry-list" id="incompleteList"></div>
                </div>
            </div>

            <!-- Summary -->
            <div id="summarySection" class="hidden">
                <h2 style="margin-bottom: 20px;">Headache Summary</h2>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
                        <h3 id="currentMonth"></h3>
                        <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <button class="btn btn-cancel" onclick="backToDashboard()">Back to Dashboard</button>

                <div id="clockView" class="clock-view hidden">
                    <h3 id="clockDate"></h3>
                    <p>Headaches throughout the day</p>
                    <div class="clock-container">
                        <div class="clock-face" id="clockFace">
                            <div class="clock-numbers" id="clockNumbers"></div>
                        </div>
                    </div>

                    <div id="symptomsDisplay" class="symptoms-display hidden">
                        <h4>Details for This Day:</h4>
                        <div id="symptomsText"></div>
                        <div id="triggersText"></div>
                        <div id="reliefText"></div>
                    </div>

                    <button class="btn btn-cancel" onclick="closeClockView()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <h2 class="settings-title">Settings</h2>
            <button class="btn settings-button" onclick="showChangePinDialog()">üîê Change PIN</button>
            <button class="btn btn-cancel" onclick="hideSettings()">Cancel</button>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="changePinModal" class="settings-modal">
        <div class="settings-content">
            <h2 class="settings-title">Change PIN</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter a new 4-digit PIN</p>
            <div class="pin-inputs">
                <input type="password" class="pin-input" maxlength="1" id="newPin1" oninput="handleNewPinInput(1)">
                <input type="password" class="pin-input" maxlength="1" id="newPin2" oninput="handleNewPinInput(2)">
                <input type="password" class="pin-input" maxlength="1" id="newPin3" oninput="handleNewPinInput(3)">
                <input type="password" class="pin-input" maxlength="1" id="newPin4" oninput="handleNewPinInput(4)">
            </div>
            <button class="btn" onclick="saveNewPin()">Save New PIN</button>
            <button class="btn btn-cancel" onclick="hideChangePinDialog()">Cancel</button>
            <div class="pin-error hidden" id="changePinError"></div>
        </div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; padding: 20px; color: white; font-size: 12px; margin-top: 20px;">
        ¬© 2024 Armenian Neuroscience Institute. All rights reserved.<br>
        Proprietary medical software for headache tracking.
    </div>

    <script>
        /* === (unchanged app logic from your file) === */
        let selectedIntensity = null;
        let headacheEntries = [];
        let currentDate = new Date();
        let editingEntryId = null;
        let isFirstTimeUser = true;
        let savedPin = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkPinStatus();
            setupPWA();
        });

        // expose handlers
        window.showSettings = showSettings;
        window.hideSettings = hideSettings;
        window.showChangePinDialog = showChangePinDialog;
        window.hideChangePinDialog = hideChangePinDialog;
        window.handleNewPinInput = handleNewPinInput;
        window.saveNewPin = saveNewPin;
        window.toggleMenstrual = toggleMenstrual;
        window.showReportHeadache = showReportHeadache;
        window.showHeadacheSummary = showHeadacheSummary;
        window.showAllEntries = showAllEntries;
        window.backToDashboard = backToDashboard;
        window.saveHeadacheEntry = saveHeadacheEntry;
        window.cancelReport = cancelReport;
        window.editEntry = editEntry;
        window.editEntryFromCalendar = editEntryFromCalendar;
        window.selectIntensity = selectIntensity;
        window.setCurrentTime = setCurrentTime;
        window.deleteEntry = deleteEntry;
        window.showIncompleteEntries = showIncompleteEntries;
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.closeClockView = closeClockView;
        window.handlePinInput = handlePinInput;
        window.handlePinSubmit = handlePinSubmit;
        window.clearReportForm = clearReportForm;
        window.checkForIncompleteEntries = checkForIncompleteEntries;

        // === PWA setup (changed to external SW + smart install prompt) ===
        function setupPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                  .then(() => console.log('SW registered'))
                  .catch(err => console.log('SW registration failed', err));
            }
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // Only show instruction banner if not already installed
                const installed = window.navigator.standalone === true;
                document.getElementById('installPrompt').style.display = installed ? 'none' : 'block';
            }
        }

        // === Data persistence (unchanged) ===
        function saveHeadacheData() {
            try {
                const dataString = JSON.stringify(headacheEntries);
                const encodedData = btoa(unescape(encodeURIComponent(dataString)));
                localStorage.setItem('headacheEntries', encodedData);
            } catch (error) {
                showError('Failed to save data securely. Please try again.');
            }
        }
        function loadHeadacheData() {
            try {
                const savedData = localStorage.getItem('headacheEntries');
                if (savedData) {
                    const decodedData = decodeURIComponent(escape(atob(savedData)));
                    headacheEntries = JSON.parse(decodedData);
                } else {
                    headacheEntries = [];
                }
            } catch {
                headacheEntries = [];
                localStorage.removeItem('headacheEntries');
            }
        }

        // === Navigation & UI helpers (unchanged) ===
        function showReportHeadache(){ document.getElementById('dashboardSection').classList.add('hidden'); document.getElementById('reportSection').classList.remove('hidden'); document.getElementById('incompleteEntriesList').classList.add('hidden'); setDefaultStartTime(); }
        function showHeadacheSummary(){ document.getElementById('dashboardSection').classList.add('hidden'); document.getElementById('summarySection').classList.remove('hidden'); renderCalendar(); }
        function showAllEntries(){ document.getElementById('dashboardSection').classList.add('hidden'); document.getElementById('editEntriesSection').classList.remove('hidden'); populateAllEntries(); }
        function backToDashboard(){ hideAllSections(); document.getElementById('dashboardSection').classList.remove('hidden'); document.getElementById('clockView').classList.add('hidden'); checkForIncompleteEntries(); }
        function hideAllSections(){ ['dashboardSection','reportSection','summarySection','editEntriesSection'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
        function showError(m){ const e=document.getElementById('errorMessage'); e.textContent=m; e.classList.remove('hidden'); setTimeout(()=>e.classList.add('hidden'),5000); }
        function showSuccess(m){ const s=document.getElementById('successMessage'); s.textContent=m; s.classList.remove('hidden'); setTimeout(()=>s.classList.add('hidden'),3000); }

        // === Incomplete Entries (unchanged) ===
        function checkForIncompleteEntries(){ const inc=headacheEntries.filter(e=>!e.endTime); document.getElementById('incompleteReminder').classList.toggle('hidden', inc.length===0); }
        function showIncompleteEntries(){ document.getElementById('dashboardSection').classList.add('hidden'); document.getElementById('reportSection').classList.remove('hidden'); document.getElementById('incompleteEntriesList').classList.remove('hidden'); const list=document.getElementById('incompleteList'); const inc=headacheEntries.filter(e=>!e.endTime); let html=''; inc.forEach(entry=>{ const st=new Date(entry.startTime); html+=`<div class="entry-item severity-${entry.intensity}" onclick="editEntry(${entry.id})"><div class="entry-header"><div class="entry-date">${st.toLocaleDateString()} ${st.toLocaleTimeString()}</div><div class="entry-intensity intensity-${entry.intensity}">${entry.intensity.toUpperCase()}</div></div><div>Click to complete this entry</div></div>`; }); list.innerHTML=html||'<div style="text-align:center;color:#666;">No incomplete entries found.</div>'; }

        // === Entries list (unchanged) ===
        function populateAllEntries(){
            const el=document.getElementById('allEntriesList');
            const entries=[...headacheEntries].sort((a,b)=>new Date(b.startTime)-new Date(a.startTime));
            if(!entries.length){ el.innerHTML='<div style="text-align:center;color:#666;padding:40px;">No headache entries found.</div>'; return; }
            let html=''; entries.forEach(entry=>{ const st=new Date(entry.startTime); const et=entry.endTime?new Date(entry.endTime):null; const status=et?'Complete':'Incomplete'; const color=et?'#28a745':'#dc3545'; html+=`<div class="entry-item severity-${entry.intensity}" onclick="editEntry(${entry.id})" style="position:relative;"><div class="entry-header" style="margin-bottom:10px;"><div class="entry-date">${st.toLocaleDateString()} ${st.toLocaleTimeString()}</div><div style="display:flex;gap:10px;align-items:center;"><div class="entry-intensity intensity-${entry.intensity}">${entry.intensity.toUpperCase()}</div><div style="font-size:12px;color:${color};font-weight:600;">${status}</div></div></div><div style="margin-bottom:8px;"><strong>Duration:</strong> ${st.toLocaleTimeString()}${et?' - '+et.toLocaleTimeString():' (ongoing)'}</div><div style="font-size:14px;color:#666;">Click to edit this entry</div><button onclick="event.stopPropagation(); deleteEntry(${entry.id})" style="position:absolute;bottom:10px;right:10px;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;font-size:12px;cursor:pointer;">Delete</button></div>`; });
            el.innerHTML=html;
        }
        function deleteEntry(entryId){ if(confirm('Are you sure you want to delete this headache entry? This action cannot be undone.')){ const i=headacheEntries.findIndex(e=>e.id===entryId); if(i!==-1){ headacheEntries.splice(i,1); saveHeadacheData(); showSuccess('Headache entry deleted successfully.'); populateAllEntries(); } } }

        // === Menstrual toggle (unchanged) ===
        function toggleMenstrual(){ const t=document.getElementById('menstrualToggle'); const c=document.getElementById('menstrualPeriod'); c.checked=!c.checked; t.classList.toggle('active', c.checked); }

        // === Edit/save entry (unchanged) ===
        function selectIntensity(i){ selectedIntensity=i; document.querySelectorAll('.intensity-btn').forEach(b=>b.classList.remove('selected')); document.querySelector(`[data-intensity="${i}"]`).classList.add('selected'); }
        function setCurrentTime(type){ const now=new Date(); const local=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16); if(type==='start') document.getElementById('startTime').value=local; else document.getElementById('endTime').value=local; }
        function editEntry(id){ const e=headacheEntries.find(x=>x.id===id); if(!e) return; editingEntryId=id; hideAllSections(); document.getElementById('reportSection').classList.remove('hidden'); document.getElementById('incompleteEntriesList').classList.add('hidden'); selectIntensity(e.intensity); document.getElementById('startTime').value=e.startTime; document.getElementById('endTime').value=e.endTime||''; document.getElementById('symptoms').value=e.symptoms||''; document.getElementById('triggers').value=e.triggers||''; document.getElementById('relief').value=e.relief||''; const t=document.getElementById('menstrualToggle'); const c=document.getElementById('menstrualPeriod'); c.checked=!!e.menstrualPeriod; t.classList.toggle('active', c.checked); document.getElementById('editingIndicator').classList.remove('hidden'); document.getElementById('reportTitle').textContent='Edit Headache Entry'; document.getElementById('reportSection').classList.add('edit-mode'); }
        function saveHeadacheEntry(){
            if(!selectedIntensity){ showError('Please select headache intensity.'); return; }
            const startTime=document.getElementById('startTime').value; if(!startTime){ showError('Please enter the start time of your headache.'); return; }
            const entry={ id: editingEntryId||Date.now(), intensity:selectedIntensity, startTime, endTime:document.getElementById('endTime').value||null, symptoms:document.getElementById('symptoms').value, triggers:document.getElementById('triggers').value, relief:document.getElementById('relief').value, menstrualPeriod:document.getElementById('menstrualPeriod').checked, timestamp:new Date().toISOString() };
            if(editingEntryId){ const i=headacheEntries.findIndex(e=>e.id===editingEntryId); headacheEntries[i]=entry; showSuccess('Headache entry updated successfully!'); } else { headacheEntries.push(entry); showSuccess('Headache entry saved successfully!'); }
            saveHeadacheData(); clearReportForm(); backToDashboard();
        }
        function cancelReport(){ clearReportForm(); backToDashboard(); }

        // === Calendar (unchanged) ===
        function renderCalendar(){
            const y=currentDate.getFullYear(), m=currentDate.getMonth();
            document.getElementById('currentMonth').textContent=currentDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
            const first=new Date(y,m,1); const start=new Date(first); start.setDate(start.getDate()-first.getDay());
            const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const h=document.createElement('div'); h.className='calendar-weekday'; h.textContent=d; grid.appendChild(h); });
            for(let i=0;i<42;i++){ const date=new Date(start); date.setDate(date.getDate()+i); const day=document.createElement('div'); day.className='calendar-day'; day.textContent=date.getDate(); if(date.getMonth()!==m) day.classList.add('other-month');
                const dateStr=date.toISOString().split('T')[0];
                const dayEntries=headacheEntries.filter(e=>e.startTime.split('T')[0]===dateStr);
                const intensity=getHighestIntensityForDate(date);
                if(intensity){ day.classList.add(`has-${intensity}`); day.onclick=()=>showClockView(date); }
                if(dayEntries.some(e=>e.menstrualPeriod===true)) day.classList.add('has-menstrual');
                grid.appendChild(day);
            }
        }
        function getHighestIntensityForDate(date){ const s=date.toISOString().split('T')[0]; const e=headacheEntries.filter(x=>x.startTime.split('T')[0]===s); if(!e.length) return null; const ints=e.map(x=>x.intensity); if(ints.includes('severe')) return 'severe'; if(ints.includes('moderate')) return 'moderate'; return 'mild'; }
        function previousMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
        function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }

        // === Clock + details (unchanged) ===
        function showClockView(date){
            const ds=date.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            document.getElementById('clockDate').textContent=ds;
            document.getElementById('clockView').classList.remove('hidden');
            renderClock(date); displaySymptomsForDate(date);
            const iso=date.toISOString().split('T')[0];
            const dayEntries=headacheEntries.filter(e=>e.startTime.split('T')[0]===iso);
            let list=document.getElementById('dayEntriesList'); if(!list){ list=document.createElement('div'); list.id='dayEntriesList'; list.className='entry-list'; list.style.marginTop='20px'; list.style.maxHeight='200px';
                const clockView=document.getElementById('clockView'); const closeBtn=clockView.querySelector('.btn-cancel'); clockView.insertBefore(list, closeBtn);
                const title=document.createElement('h4'); title.textContent='Entries for this day:'; title.style.marginBottom='10px'; clockView.insertBefore(title, list);
            }
            list.innerHTML = dayEntries.length ? dayEntries.map(entry=>{
                const st=new Date(entry.startTime); const et=entry.endTime?new Date(entry.endTime):null;
                return `<div class="entry-item severity-${entry.intensity}" onclick="editEntryFromCalendar(${entry.id})" style="margin-bottom:10px;">
                    <div class="entry-header"><div class="entry-date">${st.toLocaleTimeString()}</div>
                    <div class="entry-intensity intensity-${entry.intensity}">${entry.intensity.toUpperCase()}</div></div>
                    <div style="font-size:14px;">Duration: ${st.toLocaleTimeString()}${et?' - '+et.toLocaleTimeString():' (ongoing)'}</div>
                    <div style="font-size:12px;color:#666;margin-top:5px;">Click to edit</div></div>`;
            }).join('') : '<p style="text-align:center;color:#666;">No entries for this day</p>';
        }
        function editEntryFromCalendar(id){ closeClockView(); editEntry(id); }
        function displaySymptomsForDate(date){
            const s=date.toISOString().split('T')[0];
            const entries=headacheEntries.filter(e=>e.startTime.split('T')[0]===s);
            if(!entries.length){ document.getElementById('symptomsDisplay').classList.add('hidden'); return; }
            const sym=[], trg=[], rel=[];
            entries.forEach(e=>{ if(e.symptoms?.trim()) sym.push(e.symptoms.trim()); if(e.triggers?.trim()) trg.push(e.triggers.trim()); if(e.relief?.trim()) rel.push(e.relief.trim()); });
            let has=false, sh='', th='', rh='';
            if(sym.length){ sh=`<div style="margin-bottom:10px;"><strong>Associated Symptoms:</strong><br>${sym.join('; ')}</div>`; has=true; }
            if(trg.length){ th=`<div style="margin-bottom:10px;"><strong>Aggravating Factors:</strong><br>${trg.join('; ')}</div>`; has=true; }
            if(rel.length){ rh=`<div style="margin-bottom:10px;"><strong>Alleviating Factors:</strong><br>${rel.join('; ')}</div>`; has=true; }
            if(has){ document.getElementById('symptomsDisplay').classList.remove('hidden'); document.getElementById('symptomsText').innerHTML=sh; document.getElementById('triggersText').innerHTML=th; document.getElementById('reliefText').innerHTML=rh; }
            else document.getElementById('symptomsDisplay').classList.add('hidden');
        }
        function renderClock(date){
            const face=document.getElementById('clockFace'); const nums=document.getElementById('clockNumbers');
            nums.innerHTML=''; face.querySelectorAll('svg').forEach(s=>s.remove());
            for(let h=0; h<24; h++){ const d=document.createElement('div'); d.className='clock-number'; d.textContent=h; const ang=(h*15)-90, r=130, x=Math.cos(ang*Math.PI/180)*r+150, y=Math.sin(ang*Math.PI/180)*r+150; d.style.left=x+'px'; d.style.top=y+'px'; d.style.transform='translate(-50%,-50%)'; nums.appendChild(d); }
            const s=date.toISOString().split('T')[0]; const entries=headacheEntries.filter(e=>e.startTime.split('T')[0]===s);
            const svg=document.createElementNS("http://www.w3.org/2000/svg","svg"); svg.style.position="absolute"; svg.style.top="0"; svg.style.left="0"; svg.style.width="100%"; svg.style.height="100%"; svg.style.pointerEvents="none"; svg.setAttribute("viewBox","0 0 300 300");
            entries.forEach(e=>{
                const st=new Date(e.startTime), et=e.endTime?new Date(e.endTime):new Date(st.getTime()+60*60*1000);
                const sh=st.getHours()+st.getMinutes()/60, eh=et.getHours()+et.getMinutes()/60; let dur=eh-sh; if(dur<0) dur+=24;
                const sa=(sh*15)-90, ea=sa+(dur*15), cx=150, cy=150, ro=120, ri=70, sar=sa*Math.PI/180, ear=ea*Math.PI/180;
                const x1=cx+Math.cos(sar)*ri, y1=cy+Math.sin(sar)*ri, x2=cx+Math.cos(sar)*ro, y2=cy+Math.sin(sar)*ro, x3=cx+Math.cos(ear)*ro, y3=cy+Math.sin(ear)*ro, x4=cx+Math.cos(ear)*ri, y4=cy+Math.sin(ear)*ri;
                const laf=dur>12?1:0; const d=`M ${x1} ${y1} L ${x2} ${y2} A ${ro} ${ro} 0 ${laf} 1 ${x3} ${y3} L ${x4} ${y4} A ${ri} ${ri} 0 ${laf} 0 ${x1} ${y1}`;
                const path=document.createElementNS("http://www.w3.org/2000/svg","path");
                path.setAttribute("d", d);
                const colors={mild:"rgba(212,237,218,0.8)",moderate:"rgba(255,243,205,0.8)",severe:"rgba(248,215,218,0.8)"};
                path.setAttribute("fill", colors[e.intensity]||"rgba(200,200,200,0.8)");
                path.setAttribute("stroke", "#333"); path.setAttribute("stroke-width","1");
                svg.appendChild(path);
            });
            face.appendChild(svg);
        }
        function closeClockView(){ document.getElementById('clockView').classList.add('hidden'); }

        // === PIN logic (unchanged) ===
        function checkPinStatus(){
            savedPin = localStorage.getItem('headacheDiaryPin');
            if(!savedPin){ isFirstTimeUser=true; document.getElementById('pinTitle').textContent='Create Your PIN'; document.getElementById('pinSubtitle').textContent='Set a 4-digit PIN to secure your diary'; document.getElementById('pinButton').textContent='Create PIN'; document.getElementById('createPinSection').classList.remove('hidden'); }
            else { isFirstTimeUser=false; document.getElementById('pinTitle').textContent='Welcome Back'; document.getElementById('pinSubtitle').textContent='Enter your 4-digit PIN to continue'; document.getElementById('pinButton').textContent='Unlock'; document.getElementById('createPinSection').classList.add('hidden'); }
            setTimeout(()=>document.getElementById('pin1').focus(),100);
        }
        function handlePinInput(i){
            const cur=document.getElementById(`pin${i}`), next=document.getElementById(`pin${i+1}`), prev=document.getElementById(`pin${i-1}`);
            document.getElementById('pinError').classList.add('hidden');
            cur.classList.toggle('filled', !!cur.value);
            if(cur.value && next) next.focus();
            if(!cur.value && prev) prev.focus();
            if(i===4 && cur.value){ const all=document.getElementById('pin1').value && document.getElementById('pin2').value && document.getElementById('pin3').value; if(all) setTimeout(handlePinSubmit,100); }
        }
        function handlePinSubmit(){
            const pin = ['pin1','pin2','pin3','pin4'].map(id=>document.getElementById(id).value).join('');
            if(pin.length!==4){ showPinError('Please enter all 4 digits'); return; }
            if(isFirstTimeUser){ localStorage.setItem('headacheDiaryPin', pin); unlockDiary(); }
            else if(pin===savedPin){ unlockDiary(); }
            else { showPinError('Incorrect PIN. Please try again.'); clearPinInputs(); }
        }
        function showPinError(m){ const e=document.getElementById('pinError'); e.textContent=m; e.classList.remove('hidden'); const box=document.querySelector('.pin-container'); box.style.animation='shake 0.5s'; setTimeout(()=>box.style.animation='',500); }
        function clearPinInputs(){ for(let i=1;i<=4;i++){ const el=document.getElementById(`pin${i}`); el.value=''; el.classList.remove('filled'); } document.getElementById('pin1').focus(); }
        function unlockDiary(){ document.getElementById('pinSection').style.display='none'; loadHeadacheData(); setDefaultStartTime(); checkForIncompleteEntries(); }

        // Change PIN / Settings (unchanged)
        function showSettings(){ document.getElementById('settingsModal').classList.add('show'); }
        function hideSettings(){ document.getElementById('settingsModal').classList.remove('show'); }
        function showChangePinDialog(){ hideSettings(); document.getElementById('changePinModal').classList.add('show'); setTimeout(()=>document.getElementById('newPin1').focus(),100); }
        function hideChangePinDialog(){ document.getElementById('changePinModal').classList.remove('show'); for(let i=1;i<=4;i++){ const el=document.getElementById(`newPin${i}`); el.value=''; el.classList.remove('filled'); } }
        function handleNewPinInput(i){
            const cur=document.getElementById(`newPin${i}`), next=document.getElementById(`newPin${i+1}`), prev=document.getElementById(`newPin${i-1}`);
            document.getElementById('changePinError').classList.add('hidden');
            cur.classList.toggle('filled', !!cur.value);
            if(cur.value && next) next.focus();
            if(!cur.value && prev) prev.focus();
            if(i===4 && cur.value){ const all=document.getElementById('newPin1').value && document.getElementById('newPin2').value && document.getElementById('newPin3').value; if(all) setTimeout(saveNewPin,100); }
        }
        function saveNewPin(){
            const newPin=['newPin1','newPin2','newPin3','newPin4'].map(id=>document.getElementById(id).value).join('');
            if(newPin.length!==4){ const e=document.getElementById('changePinError'); e.textContent='Please enter all 4 digits'; e.classList.remove('hidden'); return; }
            localStorage.setItem('headacheDiaryPin', newPin); savedPin=newPin; hideChangePinDialog(); showSuccess('PIN changed successfully!');
        }

        function confirmLogout(){
            if(confirm('Are you sure you want to logout?')){
                hideSettings();
                document.getElementById('pinSection').style.display='flex';
                clearPinInputs();
                isFirstTimeUser=false;
                savedPin = localStorage.getItem('headacheDiaryPin');
                document.getElementById('pinTitle').textContent='Welcome Back';
                document.getElementById('pinSubtitle').textContent='Enter your 4-digit PIN to continue';
                document.getElementById('pinButton').textContent='Unlock';
                document.getElementById('createPinSection').classList.add('hidden');
                setTimeout(()=>document.getElementById('pin1').focus(),100);
            }
        }

        // Clock helpers (unchanged)
        (function addShake(){ const style=document.createElement('style'); style.textContent='@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}'; document.head.appendChild(style); })();

        function displaySymptomsForDate(date){
            const s=date.toISOString().split('T')[0];
            const entries=headacheEntries.filter(e=>e.startTime.split('T')[0]===s);
            if(!entries.length){ document.getElementById('symptomsDisplay').classList.add('hidden'); return; }
            const sym=[], trg=[], rel=[]; entries.forEach(e=>{ if(e.symptoms?.trim()) sym.push(e.symptoms.trim()); if(e.triggers?.trim()) trg.push(e.triggers.trim()); if(e.relief?.trim()) rel.push(e.relief.trim()); });
            let has=false, sh='', th='', rh='';
            if(sym.length){ sh=`<div style="margin-bottom:10px;"><strong>Associated Symptoms:</strong><br>${sym.join('; ')}</div>`; has=true; }
            if(trg.length){ th=`<div style="margin-bottom:10px;"><strong>Aggravating Factors:</strong><br>${trg.join('; ')}</div>`; has=true; }
            if(rel.length){ rh=`<div style="margin-bottom:10px;"><strong>Alleviating Factors:</strong><br>${rel.join('; ')}</div>`; has=true; }
            if(has){ document.getElementById('symptomsDisplay').classList.remove('hidden'); document.getElementById('symptomsText').innerHTML=sh; document.getElementById('triggersText').innerHTML=th; document.getElementById('reliefText').innerHTML=rh; }
            else document.getElementById('symptomsDisplay').classList.add('hidden');
        }

        function setDefaultStartTime(){ const now=new Date(); const local=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16); document.getElementById('startTime').value=local; }
        function clearReportForm(){ selectedIntensity=null; editingEntryId=null; document.querySelectorAll('.intensity-btn').forEach(b=>b.classList.remove('selected')); document.getElementById('startTime').value=''; document.getElementById('endTime').value=''; document.getElementById('symptoms').value=''; document.getElementById('triggers').value=''; document.getElementById('relief').value=''; document.getElementById('menstrualPeriod').checked=false; document.getElementById('menstrualToggle').classList.remove('active'); document.getElementById('editingIndicator').classList.add('hidden'); document.getElementById('reportTitle').textContent='Report New Headache'; document.getElementById('reportSection').classList.remove('edit-mode'); }
    </script>
</body>
</html>
